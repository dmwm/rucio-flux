apiVersion: v1
kind: ConfigMap
metadata:
  name: instance-fluentbit-values
  namespace: fluentbit
data:
  values.yaml: |+
    ## Mounting /etc/machine-id with FileOrCreate
    daemonSetVolumes:
    - name: varlog
      hostPath:
        path: /var/log
    - name: varlibdockercontainers
      hostPath:
        path: /var/lib/docker/containers
    - name: etcmachineid
      hostPath:
        path: /etc/machine-id
        type: FileOrCreate
    config:
      service: |
        [SERVICE]
            Daemon Off
            Flush {{ .Values.flush }}
            Log_Level {{ .Values.logLevel }}
            Parsers_File /fluent-bit/etc/parsers.conf
            Parsers_File /fluent-bit/etc/conf/custom_parsers.conf
            HTTP_Server On
            HTTP_Listen 0.0.0.0
            HTTP_Port {{ .Values.metricsPort }}
            Health_Check On

      ## https://docs.fluentbit.io/manual/pipeline/inputs
      inputs: |
        [INPUT]
            Name tail
            Path /var/log/containers/*.log
            multiline.parser docker, cri
            Tag kube.*
            Mem_Buf_Limit 5MB
            Skip_Long_Lines On
            Exclude_Path /var/log/containers/*_kube-system_*.log 
            

      ## https://docs.fluentbit.io/manual/pipeline/filters
      filters: |
        [FILTER]
            Name kubernetes
            Match kube.*
            Merge_Log On
            Keep_Log Off
            K8S-Logging.Parser On
            K8S-Logging.Exclude On

      ## https://docs.fluentbit.io/manual/pipeline/outputs
      outputs: |
        # [OUTPUT]
        #     Name es
        #     Match kube.*
        #     Host es-cms.cern.ch/es
        #     HTTP_Passwd {{ .Values.esPass }}
        #     HTTP_User {{ .Values.esUser }}
        #     Logstash_Format On
        #     Retry_Limit False

        # [OUTPUT]
        #     Name es
        #     Match host.*
        #     Host es-cms.cern.ch/es
        #     HTTP_Passwd {{ .Values.esPass }}
        #     HTTP_User {{ .Values.esUser }}
        #     Logstash_Format On
        #     Logstash_Prefix node
        #     Retry_Limit False

        [OUTPUT]
            Name stdout
            Match kube.*
            Format json_lines

      ## https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/classic-mode/upstream-servers
      ## This configuration is deprecated, please use `extraFiles` instead.
      upstream: {}

      ## https://docs.fluentbit.io/manual/pipeline/parsers
      customParsers: |
        [PARSER]
            Name docker_no_time
            Format json
            Time_Keep Off
            Time_Key time
            Time_Format %Y-%m-%dT%H:%M:%S.%L
